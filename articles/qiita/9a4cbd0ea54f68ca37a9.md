---
title: 【要件検討】Windowsでドキュメント管理するのが面倒くなったので、LAMPサーバにした
tags: Apache Metabase MySQL WordPress MongoDB
author: t_kyn
slide: false
---
※2023/12/02時点での検討内容を更新しました※
※現状として、実施済みのものは■、実施予定は□で示しています。

# 初めに
QOLを上げるため、自宅内にプライベートサーバを構築します。
そのため、前提として何がしたいのか背景から具体的にやることを整理します。
（※実際に構築していく過程は、別な記事にまとめていきたいと思います。）

# 背景
* 住宅ローンと給与明細とQR決済の月額支出をはじめとした明細管理をExcelで行っています。しかし、グラフや書式設定の追加をすることでメモリ不足となりフリーズしてしまいました。
* 覚えたことや知ったことの備忘録が一元管理されていないため、WordpressのようなCMSに移行し、利用しています。しかしながら、プラグインのセキュリティ検討や頻繁なバージョンアップを考慮すると、運用の煩雑性があるため、利用頻度が少なくなっています。
WebフレームワークでCMSを利用する検討を始めており、Python製のFlaskやDjangoを検討しています。
* QOLを上げるための材料として、明細のみならず外部サイトのオープンデータを活用したいです。
* 自宅内サーバといいつつも、将来的には災害時にサーバを持ち運びできるようにしたいです。
（災害が発生したら、災対環境を本番環境に昇格させるのが一般的なのですが、
人間の手で拠点を移動させることで、本番環境のみでも運用する思想です。）
* <b><a>要は、MicrosoftOfficeレス、分析自動化、持ち運びを可能をするため、軽量LAMPサーバを作成するのが目的です。</a></b>

# 要件検討

## 現状の管理方法
### ◎給与分析.xlsx
* 現状：月次の給与明細を記入し、収入額、控除額、手取額を記載しています。
* 課題：分析のたびにExcelからグラフを作る必要があるため、手間がかかっています。
### ◎住宅ローン予測表.xlsx
* 現状：住宅ローンが月々どれくらいかかるかを金利に応じて月次支出を計算しています。
（現在の借入銀行での返済額もあれば、有り得ない高金利のパターンなど、数10種類の変動金利パターンでシミュレーションした結果をExcelですべて計算で出しています。）
* 課題：金利変動パターンをさらに増やすと、グラフを作成すると、フリーズしてしまいます。

### ◎サーバ構成図.pptx
* 現状：仮想サーバを様々構築していて、どのVMかが分からなくなってしまったので一覧化しています。構成図はパワーポイントで管理しています。
* 課題：仮想サーバのミドルウェアのパラメータが一元管理できていないです。
また、ネットワーク含めた構成図が作れていないです。
### ◎ライフプランニング.xlsx
* 現状：月の支出を出しています。
* 課題：2022年4月以降、メンテナンスできていないです。

### ◎株価分析.xlsx
* 現状：未実装なので、なにも管理していないです。
* 課題：QR決済のポイント投資をしていますが、変動状況をウォッチできておらず、株価チャートをうまく利活用できていないのが現状です。外部サイト（複数サイトのオープンデータ）から取得し、移動平均線を解析して、買いなのか・売りなのかを判断するツールが必要があります。
（すでにアプリであると思いますが、勉強のために独自でつくりたいというのも課題です。）

## 持ち運びについて
* データセンターや社内などのオンプレでサーバを管理することもあれば、クラウドで管理されることもあると思いますが、災害時は災対環境への切替をすることでサービスを継続する設計となっています。
* 本記事では一方で、個人利用を目的としているため、自宅のWindowsPC上にVMWareをインストールし、仮想サーバ（LinuxOS）を構築しております。
* 災害時に電源をオフにして、避難先でも使えるようなコンセプトにしたいです。
（外出時の利用において、セキュリティ要件を遵守しながら運用するために、現在はWindowsPCおよびLinuxOSを搭載した仮想サーバにおいてファイアウォールを実装しています。しかしながら、ミドルウェア自体のセキュリティ管理に関しては、検討が必要です。）

# 設計検討
## ◎給与分析.xlsx
* 方針
    * ■月々の給与を挿入するために、クライアントでデータをインポートします。
    * □本格的には、javaアプリケーションを作成して、データ投入用の画面を作成して、APIを作成します。
    * □Web入力画面からデータ挿入できるAPIを作ります。
* 詳細
    * ■給与明細テーブルを作成します。
    * ■給与明細テーブルにa5m2を使って、データを挿入します。
    * ■BIツール（Metabase）で可視化します。
    * □javaアプリケーションを用いたデータ挿入を実装します。
    * □Web入力画面をPythonのFlaskもしくはDjangoで実装します。
 
## ◎住宅ローン予測表.xlsx
* 方針
    * ■住宅ローンシミュレーションをデータベース化します。
    * ■可視化ツールを導入します。
* 詳細
    * ■住宅ローンシミュレーションテーブルを作成し、MySQLでデータベース化します。
    * ■金利毎にテーブルを作成します。
    * ■金利毎のテーブルを内部結合し、金利変化の返済シミュレーションを可視化します。
    * ■BIツール（Metabase）で可視化します。
    * □追記：内部結合は多いほど、テーブル検索処理に時間がかかってしまうことがわかりました。結合処理を廃止し、金利パターンごとに列が作成されたビューを作成することで、データ検索のパフォーマンス改善を行います。

## ◎サーバ構成図.docx
* 方針
    * □ミドルウェアのパラメータを一元管理するため、サーバ一覧テーブルを作成し、データベース化します。
    * □パスワードは暗号化された値で管理します。
    * □サーバ構成図はパスワード管理し、さらにファイルも暗号化します。
* 詳細
    * □サーバ一覧についてはデータベース内にサーバ一覧専用のテーブルを作成します。
    * □記載内容をすべて暗号化し、テーブルのデータは暗号化された値で格納します。
    （暗号化してデータを入れられる機能は別途設計・実装が必要★★ここは2023/12/2時点で検討中です。）
    * □暗号化アルゴリズムとして、Javaの標準ライブラリもしくは、opensslを利用して、暗号化します。
    * データベースから参照する場合、特殊な復号方法でデータを閲覧できるようにします。
    （クライアントから直接データが解読されないようにします。）
    * サーバ構成図は、下記の通りに多段階でパスワード認証を設定します。
        * ①Apacheのベーシック認証の設定
        * ②Wordpressのファイルダウンロード時のパスワード認証設定
        * ③zipファイルにパスワード
        * ④生ファイルにパスワード設定


## ◎ライフプランニング.xlsx
* 方針
    * □QR決済のデータと、電気ガス水道のアプリのcsvデータをにインポートします。
    　⇒2023/12/2 csv出力が不可になったため、代替方法を検討しています。
    * ■住宅ローン予測と給与分析とを考慮して、収支結果を計算し、BIツールで可視化します。
* 詳細
    * ■csvファイルをスマホからアップロードします。
    * □アップロードファイルをデータベースにインポートできるような形式に加工します。
    * □加工したファイルをデータベースにはmysqlもしくはmongodbにインポートします。
    * □住宅ローン予測と給与分析用のテーブルを内部結合し、
    収支計算結果をデータベースのビューとして表示します。
    * □BIツール（Metabase）で可視化します。

## ◎株価分析.xlsx
* 方針
    * □株価のチャートのデータを、構築したサーバに取り込みします。
* 詳細
    * □外部の株価チャートをエクスポートします。
    * □エクスポートファイルをデータベースにインポートできるような形式に加工します。
    * □加工したファイルをデータベース（mysql）にインポートします。
    インポート先は株価チャートを収集するために用意した専用のテーブルとします。
    その際に移動平均線を出します。
    * □BIツール（Metabase）で可視化します。

## 接続方法については後ほど更新します。

# 構築・運用状況
## 構築の状況
構築の状況や運用の状況などは下記に記載しております。
（2023/12/2時点ではCentOS7.5からAlmalinux8.4に移行し、8.4から8.9へアップデート中の状況です。）

https://qiita.com/t_kyn/items/91f6dbb7c3ef938b9377

## 後述
* □図ファイルをピクチャファイルで管理してしまうのは個人的にはあまりよくないので、要改善です。
（Webブラウザで図形描画できるOSSはPython製のライブラリで、opencvがありそうです。）
参考：

https://note.nkmk.me/python-opencv-draw-function/

* □Metabaseでは2000件以上のデータを参照できない課題があります。
Metabaseはユーザインターフェースがよい反面、制約事項も多いBIツールであるため、Pythonを用いたBIツールを利用できないか検討中です。

参考：

https://www.learning-nao.com/?p=3915

## 追加したい機能
* □旅行サイトとQR決済のまとめ検索とか、食べログとQR決済でキャンペーンやってるお店の一覧出力機能とか。。やりたいことがいっぱい出てきました。。
* □フィットネス管理、勤怠管理の機能も追加予定。
* □そもそもとして、セキュリティ向上のため、SSH踏み台の専用サーバを構築をする予定。
* □データの更新をトリガーにgmailへのメール通知を目的としたDMZサーバを構築する予定。
（踏み台自体の認証設定は、鍵認証とパスワード認証の両方を用いて、ログイン認証を独自実装することでセキュリティのカスタマイズ化を図る予定。）
* □アクセス数に応じたスケーラビリティを実現するため、Kubernetes化し、構築予定。

